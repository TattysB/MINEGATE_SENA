<!-- Secci√≥n de Gesti√≥n de Permisos - Solo visible para superusuarios -->
<div class="seccion-gestion-permisos">
    
    <!-- Mensajes -->
    {% if messages %}
        <div class="mensajes">
            {% for message in messages %}
                <div class="alerta alerta-{{ message.tags }}">
                    <span>{{ message }}</span>
                    <button type="button" class="btn-cerrar-alerta" onclick="this.parentElement.style.display='none';">√ó</button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Tarjetas de Estad√≠sticas -->
    <div class="seccion-estadisticas">
        <div class="titulo-seccion">üìà Estad√≠sticas de Usuarios</div>
        <div class="grid-estadisticas">
            <div class="tarjeta-estadistica total">
                <div class="numero-estadistica">{{ total_usuarios }}</div>
                <div class="texto-estadistica">Total de Usuarios</div>
            </div>
            <div class="tarjeta-estadistica aprobado">
                <div class="numero-estadistica">{{ usuarios_aprobados }}</div>
                <div class="texto-estadistica">Aprobados</div>
            </div>
            <div class="tarjeta-estadistica pendiente">
                <div class="numero-estadistica">{{ usuarios_pendientes }}</div>
                <div class="texto-estadistica">Pendientes</div>
            </div>
            <div class="tarjeta-estadistica rechazado">
                <div class="numero-estadistica">{{ usuarios_rechazados }}</div>
                <div class="texto-estadistica">Rechazados</div>
            </div>
        </div>
    </div>

    <!-- Filtros y B√∫squeda -->
    <div class="seccion-filtros">
        <div class="titulo-seccion">üîç Filtros</div>
        <form method="GET" class="formulario-filtros">
            <div class="grupo-filtros">
                <div class="filtro-botones">
                    <a href="?filtro=todos" class="btn-filtro {% if filtro_actual == 'todos' %}activo{% endif %}">
                        Todos
                    </a>
                    <a href="?filtro=aprobados" class="btn-filtro {% if filtro_actual == 'aprobados' %}activo{% endif %}">
                        Aprobados
                    </a>
                    <a href="?filtro=pendientes" class="btn-filtro {% if filtro_actual == 'pendientes' %}activo{% endif %}">
                        Pendientes
                    </a>
                    <a href="?filtro=rechazados" class="btn-filtro {% if filtro_actual == 'rechazados' %}activo{% endif %}">
                        Rechazados
                    </a>
                </div>
                <div class="busqueda">
                    <input 
                        type="text" 
                        name="buscar" 
                        placeholder="Buscar por usuario, email, documento..." 
                        value="{{ buscar }}"
                        class="input-busqueda"
                    >
                    <button type="submit" class="btn-buscar">üîç Buscar</button>
                    <a href="?filtro={{ filtro_actual }}" class="btn-limpiar">Limpiar</a>
                </div>
            </div>
        </form>
    </div>

    <!-- Tabla de Usuarios -->
    <div class="seccion-tabla">
        <div class="titulo-seccion">üë• Lista de Usuarios ({{ perfiles.count }})</div>
        {% if perfiles %}
            <div class="tabla-responsiva">
                <table class="tabla-usuarios">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Documento</th>
                            <th>Email</th>
                            <th>Tel√©fono</th>
                            <th>Fecha Registro</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for perfil in perfiles %}
                            <tr class="fila-usuario {% if perfil.aprobado %}aprobado{% elif perfil.razon_rechazo %}rechazado{% else %}pendiente{% endif %}">
                                <td class="datos-usuario">
                                    <div class="nombre-usuario">{{ perfil.user.get_full_name|default:perfil.user.username }}</div>
                                    <div class="username">@{{ perfil.user.username }}</div>
                                </td>
                                <td>
                                    <span class="documento">{{ perfil.documento }}</span>
                                </td>
                                <td>
                                    <span class="email">{{ perfil.user.email }}</span>
                                </td>
                                <td>
                                    <span class="telefono">{{ perfil.telefono|default:"No especificado" }}</span>
                                </td>
                                <td>
                                    <span class="fecha">{{ perfil.user.date_joined|date:"d/m/Y H:i" }}</span>
                                </td>
                                <td>
                                    {% if perfil.aprobado %}
                                        <span class="badge badge-aprobado">‚úì APROBADO</span>
                                        <div class="fecha-aprobacion">{{ perfil.fecha_aprobacion|date:"d/m/Y" }}</div>
                                    {% elif perfil.razon_rechazo %}
                                        <span class="badge badge-rechazado">‚úó RECHAZADO</span>
                                        <div class="razon">{{ perfil.razon_rechazo|truncatewords:5 }}</div>
                                    {% else %}
                                        <span class="badge badge-pendiente">‚è≥ PENDIENTE</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="acciones-usuario">
                                        {% if not perfil.aprobado or perfil.razon_rechazo %}
                                            <button 
                                                type="button" 
                                                class="btn-accion btn-aprobar"
                                                onclick="abrirModalAprobar('{{ perfil.user.id }}', '{{ perfil.user.get_full_name|default:perfil.user.username }}')"
                                                title="Aprobar usuario"
                                            >
                                                ‚úì Aprobar
                                            </button>
                                        {% else %}
                                            <button 
                                                type="button" 
                                                class="btn-accion btn-rechazar"
                                                onclick="abrirModalRechazar('{{ perfil.user.id }}', '{{ perfil.user.get_full_name|default:perfil.user.username }}')"
                                                title="Rechazar usuario"
                                            >
                                                ‚úó Rechazar
                                            </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="sin-resultados">
                <p>üìã No se encontraron usuarios con los criterios seleccionados.</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Modal para Aprobar -->
<div id="modalAprobar" class="modal">
    <div class="modal-contenido">
        <div class="modal-encabezado">
            <h2>‚úì Aprobar Usuario</h2>
            <button class="modal-cerrar" onclick="cerrarModal('modalAprobar')">&times;</button>
        </div>
        <div class="modal-cuerpo">
            <p>¬øDeseas aprobar a <strong id="usuarioAprobar"></strong>?</p>
            <p class="texto-info">Este usuario podr√° acceder al sistema normalmente.</p>
        </div>
        <div class="modal-pie">
            <button class="btn-modal btn-cancelar" onclick="cerrarModal('modalAprobar')">Cancelar</button>
            <form id="formAprobar" method="POST" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="btn-modal btn-confirmar">S√≠, Aprobar</button>
            </form>
        </div>
    </div>
</div>

<!-- Modal para Rechazar -->
<div id="modalRechazar" class="modal">
    <div class="modal-contenido">
        <div class="modal-encabezado">
            <h2>‚úó Rechazar Usuario</h2>
            <button class="modal-cerrar" onclick="cerrarModal('modalRechazar')">&times;</button>
        </div>
        <div class="modal-cuerpo">
            <p>¬øDeseas rechazar a <strong id="usuarioRechazar"></strong>?</p>
            <div class="grupo-formulario">
                <label for="razonRechazo">Motivo del rechazo:</label>
                <textarea 
                    id="razonRechazo" 
                    name="razon" 
                    class="textarea-razon"
                    placeholder="Especifica la raz√≥n del rechazo..."
                    required
                ></textarea>
            </div>
        </div>
        <div class="modal-pie">
            <button class="btn-modal btn-cancelar" onclick="cerrarModal('modalRechazar')">Cancelar</button>
            <form id="formRechazar" method="POST" style="display: inline;">
                {% csrf_token %}
                <input type="hidden" name="razon" id="razonInput">
                <button type="button" class="btn-modal btn-confirmar" onclick="confirmarRechazar()">S√≠, Rechazar</button>
            </form>
        </div>
    </div>
</div>

<script>
    let usuarioIdAprobar = null;
    let usuarioIdRechazar = null;

    function abrirModalAprobar(usuarioId, nombreUsuario) {
        usuarioIdAprobar = usuarioId;
        document.getElementById('usuarioAprobar').textContent = nombreUsuario;
        const form = document.getElementById('formAprobar');
        form.action = `/aprobar_usuario/${usuarioId}/`;
        abrirModal('modalAprobar');
    }

    function abrirModalRechazar(usuarioId, nombreUsuario) {
        usuarioIdRechazar = usuarioId;
        document.getElementById('usuarioRechazar').textContent = nombreUsuario;
        document.getElementById('razonRechazo').value = '';
        const form = document.getElementById('formRechazar');
        form.action = `/rechazar_usuario/${usuarioId}/`;
        abrirModal('modalRechazar');
    }

    function confirmarRechazar() {
        const razon = document.getElementById('razonRechazo').value.trim();
        if (!razon) {
            alert('Por favor, especifica la raz√≥n del rechazo.');
            return;
        }
        
        document.getElementById('razonInput').value = razon;
        document.getElementById('formRechazar').submit();
    }

    function abrirModal(modalId) {
        const modal = document.getElementById(modalId);
        modal.style.display = 'flex';
    }

    function cerrarModal(modalId) {
        const modal = document.getElementById(modalId);
        modal.style.display = 'none';
    }

    // Cerrar modal si se hace clic fuera del contenido
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
        }
    }

    // Auto-cerrar alertas despu√©s de 5 segundos
    document.addEventListener('DOMContentLoaded', function() {
        const alertas = document.querySelectorAll('.alerta');
        alertas.forEach(alerta => {
            setTimeout(() => {
                alerta.style.display = 'none';
            }, 5000);
        });
    });
</script>
